<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPS速度アプリ</title>
  <style>
    /* シンプルで使いやすいモバイル向けスタイル */
    body {
      font-family: sans-serif;
      margin: 20px;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
    }
    input, button {
      font-size: 1.2em;
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #007aff;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    button:disabled {
      background: #ccc;
    }
    p {
      margin: 10px 0;
    }
    .speed-container {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }
    .speed-btn {
      width: 50px;
      flex-shrink: 0;
    }
    .speed-display {
      flex-grow: 1;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
    }
    .here-btn {
      margin: 10px 0;
    }
    .saved-locations {
      margin-top: 15px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .location-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>GPS速度発表アプリ</h1>
    <label for="intervalInput">発表間隔（秒、10秒刻み）:</label>
    <div>
      <button id="decreaseInterval">-</button>
      <input type="number" id="intervalInput" value="30" min="10" step="10" readonly>
      <button id="increaseInterval">+</button>
    </div>
    <p id="status">位置情報取得中...</p>
    
    <div class="speed-container">
      <button class="speed-btn" id="decreaseSpeed">-</button>
      <div class="speed-display"><span id="speedDisplay">0</span> ノット</div>
      <button class="speed-btn" id="increaseSpeed">+</button>
    </div>
    
    <button id="hereButton" class="here-btn">ここ</button>
    
    <div class="saved-locations">
      <h2>保存した地点</h2>
      <div id="savedLocationsList"></div>
    </div>
  </div>
  <script>
    let watchId;
    let currentPosition = null;
    let lastAnnouncedPosition = null;
    let announceIntervalId;
    let intervalSeconds = 30;
    let savedLocations = [];
    const MAX_SAVED_LOCATIONS = 5;

    const statusElem = document.getElementById('status');
    const speedDisplayElem = document.getElementById('speedDisplay');
    const intervalInput = document.getElementById('intervalInput');
    const increaseIntervalButton = document.getElementById('increaseInterval');
    const decreaseIntervalButton = document.getElementById('decreaseInterval');
    const increaseSpeedButton = document.getElementById('increaseSpeed');
    const decreaseSpeedButton = document.getElementById('decreaseSpeed');
    const hereButton = document.getElementById('hereButton');
    const savedLocationsListElem = document.getElementById('savedLocationsList');

    // 日本語の音声を選択（利用可能な場合）
    let selectedVoice = null;
    function setVoice() {
      const voices = speechSynthesis.getVoices();
      selectedVoice = voices.find(voice => voice.lang.startsWith('ja')) || null;
    }
    window.speechSynthesis.onvoiceschanged = setVoice;
    setVoice();

    // 2点間の距離（メートル）をhaversineの公式で算出
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // 地球の半径（メートル）
      const toRad = Math.PI / 180;
      const dLat = (lat2 - lat1) * toRad;
      const dLon = (lon2 - lon1) * toRad;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // 2点間の平均速度（m/s）を計算
    function calculateSpeed(lastPos, currentPos) {
      const distance = haversineDistance(
        lastPos.coords.latitude, lastPos.coords.longitude,
        currentPos.coords.latitude, currentPos.coords.longitude
      );
      const timeDiff = (currentPos.timestamp - lastPos.timestamp) / 1000; // 秒
      return timeDiff > 0 ? distance / timeDiff : 0;
    }

    // m/sからノットへの変換（1 m/s ≒ 1.94384 knot）
    function convertToKnots(mps) {
      return mps * 1.94384;
    }

    // 指定された速度（ノット）を発話する
    function speakSpeed(speedKnots) {
      // 速度が0または非常に小さい場合は「ゼロ」と発話
      const speedText = speedKnots < 0.1 
        ? "速度、ゼロ" 
        : "速度、" + speedKnots.toFixed(1);
      const utterance = new SpeechSynthesisUtterance(speedText);
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      speechSynthesis.speak(utterance);
    }

    // 画面上に速度を表示する
    function updateSpeedDisplay(speedKnots) {
      speedDisplayElem.textContent = speedKnots.toFixed(1);
    }

    // 発表タイミングで、前回の位置からの平均速度を算出して発言
    function announceCurrentSpeed() {
      if (currentPosition && lastAnnouncedPosition) {
        const speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
        const speedKnots = convertToKnots(speedMps);
        speakSpeed(speedKnots);
        updateSpeedDisplay(speedKnots);
      }
      // 次回の計算用に現在の位置を記録
      if (currentPosition) {
        lastAnnouncedPosition = currentPosition;
      }
    }

    // インターバルを増減する関数
    function changeInterval(amount) {
      let newInterval = parseInt(intervalInput.value, 10) + amount;
      if (newInterval >= 10) {
        intervalInput.value = newInterval;
        intervalSeconds = newInterval;
        
        // インターバルが変更されたら、タイマーを再設定
        if (announceIntervalId) {
          clearInterval(announceIntervalId);
          announceIntervalId = setInterval(announceCurrentSpeed, intervalSeconds * 1000);
        }
      }
    }

    // 現在地を保存する
    function saveCurrentLocation() {
      if (!currentPosition) return;
      
      const location = {
        latitude: currentPosition.coords.latitude,
        longitude: currentPosition.coords.longitude,
        timestamp: new Date().toLocaleTimeString(),
        id: Date.now()
      };
      
      // 最大5箇所まで保存（新しいものを先頭に追加）
      savedLocations.unshift(location);
      if (savedLocations.length > MAX_SAVED_LOCATIONS) {
        savedLocations.pop();
      }
      
      updateSavedLocationsList();
    }
    
    // 保存地点リストを更新
    function updateSavedLocationsList() {
      savedLocationsListElem.innerHTML = '';
      
      savedLocations.forEach(loc => {
        const distance = currentPosition ? 
          haversineDistance(
            currentPosition.coords.latitude, 
            currentPosition.coords.longitude,
            loc.latitude, 
            loc.longitude
          ) : 0;
          
        const item = document.createElement('div');
        item.className = 'location-item';
        item.innerHTML = `
          <div>${loc.timestamp}</div>
          <div>距離: ${Math.round(distance)} メートル</div>
        `;
        savedLocationsListElem.appendChild(item);
      });
    }

    // 位置情報の更新時に呼ばれる関数
    function handlePositionUpdate(pos) {
      currentPosition = pos;
      statusElem.textContent = "位置更新：" +
                             "緯度: " + pos.coords.latitude.toFixed(5) + " " +
                             "経度: " + pos.coords.longitude.toFixed(5);
      
      // 初回取得時にlastAnnouncedPositionを設定
      if (!lastAnnouncedPosition) {
        lastAnnouncedPosition = pos;
        // 初回の速度計算と発話
        announceCurrentSpeed();
        // 定期的な発話を開始
        announceIntervalId = setInterval(announceCurrentSpeed, intervalSeconds * 1000);
      }
      
      // 保存地点があれば距離を更新
      if (savedLocations.length > 0) {
        updateSavedLocationsList();
      }
    }

    // イベントリスナーの設定
    increaseIntervalButton.addEventListener('click', () => changeInterval(10));
    decreaseIntervalButton.addEventListener('click', () => changeInterval(-10));
    hereButton.addEventListener('click', saveCurrentLocation);
    
    // 模擬的な速度調整（テスト用）
    increaseSpeedButton.addEventListener('click', () => {
      const currentSpeed = parseFloat(speedDisplayElem.textContent);
      updateSpeedDisplay(Math.min(currentSpeed + 1.0, 999.9));
    });
    
    decreaseSpeedButton.addEventListener('click', () => {
      const currentSpeed = parseFloat(speedDisplayElem.textContent);
      updateSpeedDisplay(Math.max(currentSpeed - 1.0, 0));
    });

    // アプリ起動時に自動で開始
    function initialize() {
      statusElem.textContent = "位置情報取得中...";
      
      // 高精度で位置情報を取得（watchPositionで継続的に更新）
      watchId = navigator.geolocation.watchPosition(
        handlePositionUpdate,
        (err) => {
          statusElem.textContent = "エラー: " + err.message;
        },
        { enableHighAccuracy: true }
      );
    }

    // ページ読み込み時に初期化
    window.addEventListener('load', initialize);
  </script>
</body>
</html>
