<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GPSé€Ÿåº¦voiceã‚¢ãƒ—ãƒª</title>
  <!-- Supabase Client ã®è¿½åŠ  -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* ã‚·ãƒ³ãƒ—ãƒ«ã§ä½¿ã„ã‚„ã™ã„ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ã‚¹ã‚¿ã‚¤ãƒ« */
    :root {
      --background-color: #f5f5f5;
      --container-background: #fff;
      --text-color: #333;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
      --muted-text-color: #666;
    }

    [data-theme="dark"] {
      --background-color: #1a1a1a;
      --container-background: #2d2d2d;
      --text-color: #ffffff;
      --border-color: #404040;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --muted-text-color: #aaa;
    }

    body {
      font-family: sans-serif;
      margin: 20px;
      background: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    
    /* ç·šã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
    @keyframes pulseLine {
      0% { stroke-width: 5px; filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)); }
      50% { stroke-width: 9px; filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)); }
      100% { stroke-width: 5px; filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)); }
    }
    
    /* è©³ç´°çµŒè·¯ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
    @keyframes pulseDetailedLine {
      0% { stroke-width: 4px; filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)); }
      50% { stroke-width: 8px; filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.8)); }
      100% { stroke-width: 4px; filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.8)); }
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ã‚¯ãƒ©ã‚¹ */
    .animated-line {
      animation: pulseLine 1.5s infinite ease-in-out;
      filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.8));
    }
    
    .animated-detailed-line {
      animation: pulseDetailedLine 1.5s infinite ease-in-out;
      filter: drop-shadow(0 0 3px rgba(255, 255, 255, 0.8));
    }
    
    .container {
      max-width: 500px;
      margin: auto;
      background: var(--container-background);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px var(--shadow-color);
      width: 100%;
      box-sizing: border-box;
      transition: background-color 0.3s ease;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
    }
    input, button {
      font-size: 1.2em;
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      background: #007aff;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    button:disabled {
      background: #ccc;
    }
    p {
      margin: 10px 0;
    }
    .speed-container {
      display: flex;
      align-items: center;
      margin: 15px 0;
    }
    .speed-btn {
      width: 100%;
      flex-shrink: 0;
      background: #ffcc00;
      color: #333;
    }
    .speed-display {
      flex-grow: 1;
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      cursor: pointer; /* ã‚¿ãƒƒãƒ—å¯èƒ½ãªã“ã¨ã‚’ç¤ºã™ã‚«ãƒ¼ã‚½ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ  */
    }
    .interval-container {
      display: flex;
      align-items: center;
      justify-content: center; /* ä¸­å¤®ã«é…ç½® */
      margin: 15px 0;
    }
    .speed-btn {
      width: 30%;
      flex-shrink: 0;
      color: #333;
    }
    #decreaseInterval {
      background: #ffcc00; /* - ãƒœã‚¿ãƒ³ã‚’é»„è‰²ã« */
    }
    #increaseInterval {
      background: #00bfff; /* + ãƒœã‚¿ãƒ³ã‚’æ°´è‰²ã« */
    }
    .interval-display {
      display: inline-flex; /* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ã§é…ç½® */
      align-items: baseline; /* ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã§æƒãˆã‚‹ */
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      cursor: pointer; /* ã‚¿ãƒƒãƒ—å¯èƒ½ãªã“ã¨ã‚’ç¤ºã™ */
      position: relative; /* å˜ä½ã®é…ç½®ã®ãŸã‚ */
    }
    .interval-unit {
      font-size: 0.5em;
      font-weight: normal;
      margin-left: 2px; /* æ•°å­—ã¨å˜ä½ã®é–“éš”ã‚’èª¿æ•´ */
    }
    .here-btn {
      margin: 10px 0;
      background: #ff3b30;
    }
    .saved-locations {
      margin-top: 15px;
      border-top: 1px solid #ddd;
      padding-top: 10px;
    }
    .location-item {
      position: relative;
      padding: 5px 0;
      touch-action: pan-y pinch-zoom;
      transition: transform 0.3s ease-out, background-color 0.3s ease-out;
      background: var(--container-background);
      border-bottom: 1px solid var(--border-color);
      color: var(--text-color);
    }
    .location-item.swiping {
      cursor: grabbing;
    }
    .location-item.will-delete {
      background: #ffebee;
      transform: translateX(100px);
      opacity: 0.5;
    }
    /* å‰Šé™¤ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .delete-icon {
      position: fixed;
      right: calc(50% - 250px + 20px); /* containerã®å³ç«¯ã‹ã‚‰20px */
      top: 50%;
      transform: translateY(-50%);
      opacity: 0;
      transition: opacity 0.3s ease-out;
      color: #fff;
      background: #ff3b30;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    @media (max-width: 540px) {
      .delete-icon {
        right: 20px; /* ç”»é¢å¹…ãŒç‹­ã„å ´åˆã¯å³ç«¯ã‹ã‚‰20px */
      }
    }
    .location-item.will-delete .delete-icon {
      opacity: 1;
    }
    .location-stats {
      text-align: center;
      font-size: 0.9em;
      color: var(--muted-text-color);
    }
    .time-display {
      font-size: 0.9em;
      font-weight: normal;
      color: var(--text-color);
    }
    .latest-time-display {
      font-size: 0.9em;
      font-weight: normal;
      color: var(--text-color);
    }
    .distance-display {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--text-color);
    }
    .direction-display {
      font-size: 1.1em;
      font-weight: bold;
      color: var(--text-color);
    }
    .direction-text {
      font-size: 1.1em;
      font-weight: bold;
      color: var(--text-color);
    }
    .speed-value {
      font-size: 1.7em;
      font-weight: bold;
      color: var(--text-color);
    }
    .minutes-value {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--text-color);
    }
    .muted-seconds {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--muted-text-color);
    }
    /* ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .speech-log-item {
      padding: 5px 0;
      border-bottom: 1px solid #eee;
      font-size: 0.9em;
    }
    
    /* ãƒãƒƒãƒ—è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¹ã‚¿ã‚¤ãƒ« */
    .map-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 1000;
    }
    
    .map-modal-content {
      position: relative;
      width: 90%;
      height: 80%;
      margin: 10% auto;
      background-color: var(--container-background);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    #map {
      width: 100%;
      height: 100%;
    }
    
    .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      background-color: #fff;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      font-weight: bold;
      color: #333;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 1001;
    }

    /* é€Ÿåº¦ã«åŸºã¥ã„ãŸè‰²åˆ†ã‘è¡¨ç¤ºã®ãŸã‚ã®å‡¡ä¾‹ */
    .speed-legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background-color: var(--container-background);
      padding: 8px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      display: block; /* noneã‹ã‚‰blockã«å¤‰æ›´ã—ã¦åˆæœŸè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
      cursor: pointer; /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
    }

    .speed-legend-gradient {
      width: 150px;
      height: 15px;
      background: linear-gradient(to right, blue, green, red);
      margin-bottom: 5px;
      position: relative;
    }

    /* é€Ÿåº¦ç¯„å›²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .speed-range-overlay {
      position: absolute;
      top: 0;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }

    /* æ˜æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤ */
    /*@keyframes pulse {
      0% { opacity: 0.1; }
      100% { opacity: 0.7; }
    }*/

    .speed-legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--text-color);
    }

    .speed-legend-mode {
      text-align: center;
      font-size: 10px;
      margin-top: 2px;
      font-weight: bold;
    }

    /* ãƒãƒƒãƒ—è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« - ä¸è¦ã«ãªã£ãŸãŸã‚å‰Šé™¤ */
    .map-toggle-container {
      display: none; /* éè¡¨ç¤ºã«ã™ã‚‹ */
    }

    /* ç¾åœ¨åœ°è¿½è·¡ãƒœã‚¿ãƒ³ */
    .track-mode-btn {
      position: absolute;
      bottom: 90px;
      right: 10px;
      width: 40px;
      height: 40px;
      background-color: var(--container-background);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      color: var(--text-color);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      z-index: 999;
    }

    .track-mode-btn.active {
      background-color: #007aff;
      color: white;
    }

    /* æƒ…å ±ãƒ‘ãƒãƒ« */
    .map-info-panel {
      position: absolute;
      bottom: 20px;
      left: 10px;
      background-color: var(--container-background);
      padding: 8px 12px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      z-index: 999;
      max-width: 200px;
      font-size: 12px;
      color: var(--text-color);
      cursor: pointer;
      height: 40px; /* 2è¡Œåˆ†ã®é«˜ã•ã«å›ºå®š */
      overflow: hidden; /* å†…å®¹ãŒæº¢ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
      width: 116px; /* åˆæœŸã®å¹…ã‚’116pxã«è¨­å®š */
    }

    /* ãƒ›ãƒãƒ¼åŠ¹æœã‚’å‰Šé™¤ */
    /*.map-info-panel:hover {
      background-color: rgba(0, 122, 255, 0.1);
    }*/

    .map-info-data {
      margin: 4px 0;
    }

    /* SVGãƒ‘ã‚¹ã®å½±åŠ¹æœ */
    .leaflet-interactive {
      transition: filter 0.3s ease;
    }
    
    /* é¸æŠã•ã‚ŒãŸé€Ÿåº¦ç¯„å›²ã®ç·šã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .speed-highlighted-path {
      filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.9)) !important;
      z-index: 1000 !important;
    }
    
    /* é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯ */
    .speed-marker {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 30px;
      height: 30px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      font-weight: bold;
      font-size: 10px;
      color: #333;
      border: 2px solid #007aff;
      cursor: move;
      z-index: 1001;
    }
  </style>
  <!-- ResponsiveVoice.jsã‚’è¿½åŠ  -->
  <script src="https://code.responsivevoice.org/responsivevoice.js?key=YOUR_API_KEY"></script>
  <!-- Google Maps APIã®å‚ç…§ã‚’å‰Šé™¤ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Hammer.jsã‚’è¿½åŠ  -->
  <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="interval-container">
      <div class="interval-display" id="intervalDisplayContainer">
        <span id="intervalDisplay">30</span>
        <span class="interval-unit">s</span>
      </div>
    </div>
    <p id="status">ä½ç½®æƒ…å ±å–å¾—ä¸­...</p>
    
    <div class="speed-container">
      <div class="speed-display" id="speedDisplayContainer"><span id="speedDisplay">0</span> ãƒãƒƒãƒˆ</div>
    </div>
    
    <button id="hereButton" class="here-btn">ã“ã“</button>
    
    <div class="saved-locations">
      <h4 id="savedLocationsTitle">ä¿å­˜ã—ãŸåœ°ç‚¹</h4>
      <div id="savedLocationsList"></div>
    </div>
    
  </div>
  
  <!-- ãƒãƒƒãƒ—è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆæ‹¡å¼µç‰ˆï¼‰ -->
  <div id="mapModal" class="map-modal">
    <div class="map-modal-content">
      <div id="map"></div>
      <div class="close-btn" id="closeMapBtn">Ã—</div>
      
      <!-- ãƒãƒƒãƒ—è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ - éè¡¨ç¤ºã«ã™ã‚‹ãŒã€ã‚³ãƒ¼ãƒ‰ã®äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã™ -->
      <div class="map-toggle-container">
        <button class="map-toggle-btn active" id="toggleMapMode">é€Ÿåº¦</button>
      </div>
      
      <!-- é€Ÿåº¦å‡¡ä¾‹ -->
      <div class="speed-legend" id="speedLegend">
        <div class="speed-legend-gradient"></div>
        <div class="speed-legend-labels">
          <span>0</span>
          <span>5</span>
          <span>10+</span>
        </div>
        <div class="speed-legend-mode" id="speedLegendMode">é€Ÿåº¦ (ãƒãƒƒãƒˆ)</div>
      </div>
      
      <!-- è¿½è·¡ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ -->
      <div class="track-mode-btn" id="trackModeBtn">ğŸ“</div>
      
      <!-- æƒ…å ±ãƒ‘ãƒãƒ« - ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
      <div class="map-info-panel" id="mapInfoPanel">
        <div class="map-info-data" id="mapSelectedSpeed" style="display: none;">é¸æŠ: 0.0 ãƒãƒƒãƒˆ</div>
        <div class="map-info-data" id="mapSelectedTime" style="display: none;">æ™‚é–“: -- åˆ†å‰</div>
      </div>
    </div>
  </div>
  
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©
    let watchId;
    let currentPosition = null;
    let lastAnnouncedPosition = null;
    let announceIntervalId;
    let intervalSeconds = 30;
    let savedLocations = [];
    const MAX_SAVED_LOCATIONS = 5;
    let speedHistory = [];
    const MAX_SPEED_HISTORY = 5;
    const MAX_SPEECH_LOG = 10;
    let speechHistory = [];
    let lastSpeechTime = 0;
    const MIN_SPEECH_INTERVAL = 7000;
    const INTERVAL_VALUES = [null, 10, 30, 50, 120, 240];
    
    // é€Ÿåº¦è¡¨ç¤ºç”¨ã®è©³ç´°ãªä½ç½®æƒ…å ±ã‚’ä¿æŒã™ã‚‹é…åˆ—
    let detailedPositionHistory = [];
    const DETAILED_POSITION_INTERVAL = 5000; // 5ç§’é–“éš”
    let lastDetailedPositionTime = 0;
    const MAX_DETAILED_POSITIONS = 100; // æœ€å¤§ä¿æŒæ•°
    
    // é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯é–¢é€£ã®å¤‰æ•°
    let speedMarker = null;
    let selectedSegment = null;
    let speedMarkerTimer = null;
    const SPEED_MARKER_TIMEOUT = 30000; // 30ç§’

    // Supabaseã®åˆæœŸåŒ–ã‚’è¡Œã†é–¢æ•°
    async function initializeSupabase() {
      const SUPABASE_URL = 'https://ylsoibodesucxrxofuir.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inlsc29pYm9kZXN1Y3hyeG9mdWlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE1MTA5MzAsImV4cCI6MjA1NzA4NjkzMH0.keB3IujuD-9-398opVDmChBETN0DhNy4u2iaQKdbGtU';
      
      try {
        return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      } catch (error) {
        console.error('Supabase initialization failed:', error);
        return null;
      }
    }

    // Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã¨ãƒªãƒˆãƒ©ã‚¤
    let supabaseClient = null;
    async function setupSupabaseClient() {
      supabaseClient = await initializeSupabase();
      if (!supabaseClient) {
        console.log('Supabase client initialization failed. Retrying in 5 seconds...');
        setTimeout(setupSupabaseClient, 5000); // 5ç§’å¾Œã«å†è©¦è¡Œ
      }
    }

    // åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
    setupSupabaseClient();

    // ãƒ¬ãƒ¼ã‚¹æƒ…å ±
    let raceUuid = null;
    let racePassword = null;
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼
    let offlineQueue = [];
    const OFFLINE_QUEUE_KEY = 'gpsOfflineQueue';

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—
    function getRaceInfoFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      raceUuid = urlParams.get('race');
      racePassword = urlParams.get('pwd');
      return raceUuid && racePassword;
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã®ä¿å­˜
    function saveOfflineQueue() {
      localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(offlineQueue));
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿
    function loadOfflineQueue() {
      const saved = localStorage.getItem(OFFLINE_QUEUE_KEY);
      if (saved) {
        offlineQueue = JSON.parse(saved);
      }
    }

    // Supabaseã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
    async function sendToSupabase(data) {
      if (!supabaseClient) {
        console.error('Supabase client is not initialized.');
        return false;
      }

      if (!raceUuid || !racePassword) return;

      try {
        const { data: result, error } = await supabaseClient
          .rpc('insert_race_tracking', {
            p_race_uuid: raceUuid,
            p_race_password: racePassword,
            p_latitude: data.coords.latitude,
            p_longitude: data.coords.longitude,
            p_timestamp: new Date(data.timestamp).toISOString(),
            p_accuracy: data.coords.accuracy,
            p_altitude: data.coords.altitude,
            p_altitude_accuracy: data.coords.altitudeAccuracy,
            p_heading: data.coords.heading,
            p_speed: data.coords.speed
          });

        if (error || !result.success) {
          console.error('Supabase error:', error || result.error);
          return false;
        }
        return true;
      } catch (e) {
        console.error('Network error:', e);
        return false;
      }
    }

    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†
    async function processOfflineQueue() {
      if (!navigator.onLine || offlineQueue.length === 0) return;

      const successfulUploads = [];
      
      for (let i = 0; i < offlineQueue.length; i++) {
        const success = await sendToSupabase(offlineQueue[i]);
        if (success) {
          successfulUploads.push(i);
        } else {
          break; // é€ä¿¡ã«å¤±æ•—ã—ãŸã‚‰å‡¦ç†ã‚’ä¸­æ–­
        }
      }

      // æˆåŠŸã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‰Šé™¤
      offlineQueue = offlineQueue.filter((_, index) => !successfulUploads.includes(index));
      saveOfflineQueue();
    }

    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®ç›£è¦–
    window.addEventListener('online', processOfflineQueue);

    const statusElem = document.getElementById('status');
    const speedDisplayElem = document.getElementById('speedDisplay');
    const speedDisplayContainerElem = document.getElementById('speedDisplayContainer');
    const intervalDisplayElem = document.getElementById('intervalDisplay');
    const intervalDisplayContainerElem = document.getElementById('intervalDisplayContainer');
    const hereButton = document.getElementById('hereButton');
    const savedLocationsListElem = document.getElementById('savedLocationsList');
    const savedLocationsTitle = document.getElementById('savedLocationsTitle');

    // æ—¥æœ¬èªã®éŸ³å£°ã‚’é¸æŠï¼ˆåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
    let selectedVoice = null;
    function setVoice() {
      const voices = speechSynthesis.getVoices();
      selectedVoice = voices.find(voice => voice.lang.startsWith('ja')) || null;
    }
    window.speechSynthesis.onvoiceschanged = setVoice;
    setVoice();

    // 2ç‚¹é–“ã®è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ã‚’haversineã®å…¬å¼ã§ç®—å‡º
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // åœ°çƒã®åŠå¾„ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
      const toRad = Math.PI / 180;
      const dLat = (lat2 - lat1) * toRad;
      const dLon = (lon2 - lon1) * toRad;
      const a = Math.sin(dLat / 2) ** 2 +
                Math.cos(lat1 * toRad) * Math.cos(lat2 * toRad) *
                Math.sin(dLon / 2) ** 2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // 2ç‚¹é–“ã®å¹³å‡é€Ÿåº¦ï¼ˆm/sï¼‰ã‚’è¨ˆç®—
    function calculateSpeed(lastPos, currentPos) {
      const distance = haversineDistance(
        lastPos.coords.latitude, lastPos.coords.longitude,
        currentPos.coords.latitude, currentPos.coords.longitude
      );
      const timeDiff = (currentPos.timestamp - lastPos.timestamp) / 1000; // ç§’
      return timeDiff > 0 ? distance / timeDiff : 0;
    }

    // m/sã‹ã‚‰ãƒãƒƒãƒˆã¸ã®å¤‰æ›ï¼ˆ1 m/s â‰’ 1.94384 knotï¼‰
    function convertToKnots(mps) {
      return mps * 1.94384;
    }

    // é€Ÿåº¦ã®ç§»å‹•å¹³å‡ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function getSmoothedSpeed(newSpeed) {
      // é€Ÿåº¦ãŒæ€¥æ¿€ã«å¤‰åŒ–ã—ãŸå ´åˆã§ã‚‚å±¥æ­´ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã—ãªã„
      // ä¾‹ï¼šç¾åœ¨ã®å±¥æ­´ã®å¹³å‡ã¨æ–°ã—ã„é€Ÿåº¦ã®å·®ãŒ1.5ãƒãƒƒãƒˆä»¥ä¸Šã‚ã‚‹å ´åˆ
      if (speedHistory.length > 0) {
        const currentAvg = speedHistory.reduce((acc, speed) => acc + speed, 0) / speedHistory.length;
        if (Math.abs(currentAvg - newSpeed) > 1.5) {
          // å±¥æ­´ã‚’å®Œå…¨ã«ãƒªã‚»ãƒƒãƒˆã›ãšã€æ–°ã—ã„å€¤ã‚’è¿½åŠ 
          speedHistory = [newSpeed, currentAvg];
        } else {
          // æ–°ã—ã„é€Ÿåº¦ã‚’å±¥æ­´ã«è¿½åŠ 
          speedHistory.unshift(newSpeed);
        }
      } else {
        // å±¥æ­´ãŒãªã„å ´åˆã¯æ–°ã—ã„é€Ÿåº¦ã‚’è¿½åŠ 
        speedHistory.push(newSpeed);
      }
      
      // å±¥æ­´ãŒæœ€å¤§æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      if (speedHistory.length > MAX_SPEED_HISTORY) {
        speedHistory.pop();
      }
      
      // å¸¸ã«å€¤ã‚’è¿”ã™ï¼ˆååˆ†ãªãƒ‡ãƒ¼ã‚¿ãŒãªãã¦ã‚‚ï¼‰
      const sum = speedHistory.reduce((acc, speed) => acc + speed, 0);
      const avgSpeed = sum / speedHistory.length;
      
      // åœæ­¢çŠ¶æ…‹ã®åˆ¤å®šï¼ˆé–¾å€¤ä»¥ä¸‹ãªã‚‰0ã¨ã¿ãªã™ï¼‰
      return avgSpeed < 0.5 ? 0 : avgSpeed;
    }

    // ç”»é¢ä¸Šã«é€Ÿåº¦ã‚’è¡¨ç¤ºã™ã‚‹
    function updateSpeedDisplay(speedKnots) {
      // nullã®å ´åˆã§ã‚‚0ã¨è¡¨ç¤ºï¼ˆã€Œè¨ˆæ¸¬ä¸­...ã€ã¨è¡¨ç¤ºã—ãªã„ï¼‰
      if (speedKnots === null) {
        speedDisplayElem.textContent = "0.0";
      } else {
        // é€Ÿåº¦è¡¨ç¤ºï¼ˆã™ã§ã«ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°æ¸ˆã¿ã®å€¤ã‚’å—ã‘å–ã‚‹ï¼‰
        speedDisplayElem.textContent = speedKnots.toFixed(1);
      }
      
      // ãƒãƒƒãƒ—æƒ…å ±ãƒ‘ãƒãƒ«ã‚‚æ›´æ–°
      if (document.getElementById('mapCurrentSpeed')) {
        document.getElementById('mapCurrentSpeed').textContent = `é€Ÿåº¦: ${speedKnots ? speedKnots.toFixed(1) : "0.0"} ãƒãƒƒãƒˆ`;
      }
    }

    let isAudioInitialized = false;

    // æŒ‡å®šã•ã‚ŒãŸé€Ÿåº¦ï¼ˆãƒãƒƒãƒˆï¼‰ã‚’ç™ºè©±ã™ã‚‹
    function speakSpeed(speedKnots) {
      // é€Ÿåº¦ãŒ0ã¾ãŸã¯éå¸¸ã«å°ã•ã„å ´åˆã¯ã€Œã‚¼ãƒ­ã€ã¨ç™ºè©±
      const speedText = speedKnots < 0.1 
        ? "é€Ÿåº¦ã€ã‚¼ãƒ­" 
        : "é€Ÿåº¦ã€" + speedKnots.toFixed(1);
      
      const utterance = new SpeechSynthesisUtterance(speedText);
      utterance.lang = 'ja-JP';
      utterance.rate = 1.0;
      utterance.pitch = 1.0;
      
      if (selectedVoice) {
        utterance.voice = selectedVoice;
      }
      
      // éŸ³å£°ã‚’å†ç”Ÿ
      window.speechSynthesis.speak(utterance);
      
      // ç™ºè©±æ™‚åˆ»ã‚’è¨˜éŒ²
      lastSpeechTime = Date.now();
      
    }

    // åˆå›ã®ãƒœã‚¿ãƒ³æŠ¼ä¸‹ã§éŸ³å£°å†ç”Ÿã‚’è¨±å¯
    function initializeAudio() {
      if (!isAudioInitialized) {
        // åˆå›ã®éŸ³å£°å†ç”Ÿã‚’è¡Œã„ã€ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        speakSpeed(0);
        isAudioInitialized = true;
        
        // å®šæœŸçš„ã«éŸ³å£°ã‚’å†ç”Ÿã™ã‚‹ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
        if (announceIntervalId) {
          clearInterval(announceIntervalId);
        }
        
        if (intervalSeconds !== null) {
          announceIntervalId = setInterval(() => {
            if (currentPosition && lastAnnouncedPosition) {
              const speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
              const speedKnots = convertToKnots(speedMps);
              const smoothedSpeed = getSmoothedSpeed(speedKnots);
              updateSpeedDisplay(smoothedSpeed);
              
              // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸé€Ÿåº¦ãŒnullã§ãªã„å ´åˆã®ã¿ç™ºè©±
              if (smoothedSpeed !== null) {
                speakSpeed(smoothedSpeed);
                // æ¬¡å›ã®è¨ˆç®—ç”¨ã«ç¾åœ¨ã®ä½ç½®ã‚’è¨˜éŒ²
                lastAnnouncedPosition = currentPosition;
              }
            }
          }, intervalSeconds * 1000);
        }
      }
    }

    // ã€Œã“ã“ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById('hereButton').addEventListener('click', () => {
      initializeAudio();
    });

    // é€Ÿåº¦è¡¨ç¤ºéƒ¨åˆ†ã®ã‚¿ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
    speedDisplayContainerElem.addEventListener('click', () => {
      initializeAudio();
      
      // ç¾åœ¨ã®é€Ÿåº¦ã‚’å³åº§ã«èª­ã¿ä¸Šã’ã‚‹
      if (currentPosition && lastAnnouncedPosition) {
        let speedMps;
        
        if (currentPosition.coords.speed !== null && currentPosition.coords.speed !== undefined) {
          speedMps = currentPosition.coords.speed;
        } else {
          speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
        }
        
        const speedKnots = convertToKnots(speedMps);
        const smoothedSpeed = getSmoothedSpeed(speedKnots);
        
        // å‰å›ã®ç™ºè©±ã‹ã‚‰7ç§’ä»¥ä¸ŠçµŒéã—ã¦ã„ã‚‹å ´åˆã®ã¿ç™ºè©±
        const now = Date.now();
        if (now - lastSpeechTime >= MIN_SPEECH_INTERVAL) {
          speakSpeed(smoothedSpeed);
        }
      }
    });

    // ç™ºè¡¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã€å‰å›ã®ä½ç½®ã‹ã‚‰ã®å¹³å‡é€Ÿåº¦ã‚’ç®—å‡ºã—ã¦ç™ºè¨€
    function announceCurrentSpeed() {
      if (currentPosition && lastAnnouncedPosition) {
        let speedMps;
        
        // GeolocationCoordinates.speedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
        if (currentPosition.coords.speed !== null && currentPosition.coords.speed !== undefined) {
          speedMps = currentPosition.coords.speed;
        } else {
          // å¾“æ¥ã®æ–¹æ³•ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
        }
        
        const speedKnots = convertToKnots(speedMps);
        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸé€Ÿåº¦ã‚’è¨ˆç®—
        const smoothedSpeed = getSmoothedSpeed(speedKnots);
        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸé€Ÿåº¦ã§è¡¨ç¤ºã¨ç™ºè©±ã‚’è¡Œã†
        updateSpeedDisplay(smoothedSpeed);
        
        // æ¬¡å›ã®è¨ˆç®—ç”¨ã«ç¾åœ¨ã®ä½ç½®ã‚’è¨˜éŒ²ï¼ˆç™ºè©±ã®å‰ã«æ›´æ–°ï¼‰
        if (currentPosition) {
          lastAnnouncedPosition = currentPosition;
        }
        
        // å‰å›ã®ç™ºè©±ã‹ã‚‰7ç§’ä»¥å†…ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        const now = Date.now();
        if (now - lastSpeechTime < MIN_SPEECH_INTERVAL) {
          // ã‚¹ã‚­ãƒƒãƒ—
        } else {
          speakSpeed(smoothedSpeed);
        }
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç§’æ•°ã‚’å–å¾—
    function loadIntervalFromStorage() {
      const savedInterval = localStorage.getItem('intervalSeconds');
      if (savedInterval && INTERVAL_VALUES.includes(savedInterval === "null" ? null : parseInt(savedInterval, 10))) {
        intervalSeconds = savedInterval === "null" ? null : parseInt(savedInterval, 10);
      } else {
        intervalSeconds = 30; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®30ç§’ã«è¨­å®š
      }
      intervalDisplayElem.textContent = intervalSeconds === null ? "ãƒŸãƒ¥ãƒ¼ãƒˆ" : intervalSeconds + "s";
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ç§’æ•°ã‚’ä¿å­˜
    function saveIntervalToStorage() {
      localStorage.setItem('intervalSeconds', intervalSeconds);
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜ã—ãŸåœ°ç‚¹ã‚’å–å¾—
    function loadSavedLocationsFromStorage() {
      const savedLocationsData = localStorage.getItem('savedLocations');
      if (savedLocationsData) {
        savedLocations = JSON.parse(savedLocationsData);
        updateSavedLocationsList();
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã—ãŸåœ°ç‚¹ã‚’ä¿å­˜
    function saveLocationsToStorage() {
      localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
    }

    // é–“éš”ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹é–¢æ•°
    function toggleInterval() {
      const currentInterval = parseInt(intervalDisplayElem.textContent, 10) || null;
      let nextIndex = 0;
      for (let i = 0; i < INTERVAL_VALUES.length; i++) {
        if (currentInterval === INTERVAL_VALUES[i]) {
          nextIndex = (i + 1) % INTERVAL_VALUES.length;
          break;
        }
      }
      
      intervalSeconds = INTERVAL_VALUES[nextIndex];
      intervalDisplayElem.textContent = intervalSeconds === null ? "ãƒŸãƒ¥ãƒ¼ãƒˆ" : intervalSeconds + "s";
      saveIntervalToStorage();
      
      // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (announceIntervalId) {
        clearInterval(announceIntervalId);
        announceIntervalId = null;
      }
      
      // æ–°ã—ã„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã§ã‚¿ã‚¤ãƒãƒ¼ã‚’å†è¨­å®šï¼ˆãƒŸãƒ¥ãƒ¼ãƒˆã§ãªã„å ´åˆã®ã¿ï¼‰
      if (intervalSeconds !== null && isAudioInitialized) {
        announceIntervalId = setInterval(() => {
          if (currentPosition && lastAnnouncedPosition) {
            const speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
            const speedKnots = convertToKnots(speedMps);
            const smoothedSpeed = getSmoothedSpeed(speedKnots);
            updateSpeedDisplay(smoothedSpeed);
            
            // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸé€Ÿåº¦ãŒnullã§ãªã„å ´åˆã®ã¿ç™ºè©±
            if (smoothedSpeed !== null) {
              speakSpeed(smoothedSpeed);
              // æ¬¡å›ã®è¨ˆç®—ç”¨ã«ç¾åœ¨ã®ä½ç½®ã‚’è¨˜éŒ²
              lastAnnouncedPosition = currentPosition;
            }
          }
        }, intervalSeconds * 1000);
      }
    }

    // 2ç‚¹é–“ã®æ–¹ä½è§’ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆåº¦æ•°æ³•ï¼‰
    function calculateBearing(lat1, lon1, lat2, lon2) {
      const toRad = Math.PI / 180;
      const y = Math.sin((lon2 - lon1) * toRad) * Math.cos(lat2 * toRad);
      const x = Math.cos(lat1 * toRad) * Math.sin(lat2 * toRad) -
                Math.sin(lat1 * toRad) * Math.cos(lat2 * toRad) * Math.cos((lon2 - lon1) * toRad);
      let bearing = Math.atan2(y, x) * 180 / Math.PI;
      bearing = (bearing + 360) % 360; // 0-360åº¦ã«æ­£è¦åŒ–
      return bearing;
    }

    // æ–¹ä½è§’ã‚’16æ–¹ä½ã®æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function bearingToDirection(bearing) {
      const directions = ['åŒ—', 'åŒ—åŒ—æ±', 'åŒ—æ±', 'æ±åŒ—æ±', 'æ±', 'æ±å—æ±', 'å—æ±', 'å—å—æ±', 
                          'å—', 'å—å—è¥¿', 'å—è¥¿', 'è¥¿å—è¥¿', 'è¥¿', 'è¥¿åŒ—è¥¿', 'åŒ—è¥¿', 'åŒ—åŒ—è¥¿'];
      const index = Math.round(bearing / 22.5) % 16;
      return directions[index];
    }

    // ç¾åœ¨åœ°ã‚’ä¿å­˜ã™ã‚‹
    function saveCurrentLocation() {
      if (!currentPosition) return;
      
      const distance = 0; // ä¿å­˜æ™‚ç‚¹ã§ã¯è‡ªåˆ†ã®ä½ç½®ãªã®ã§è·é›¢ã¯0
      
      // ç¾åœ¨ã®æ™‚åˆ»ã‚’å–å¾—
      const now = new Date();
      const timeString = now.toLocaleTimeString('ja-JP', {hour12: false});
      const timeMatch = timeString.match(/(\d+):(\d+):(\d+)/);
      let formattedTime = timeString;
      
      if (timeMatch) {
        formattedTime = `<span class="latest-time-display">${timeMatch[1]}:${timeMatch[2]}</span> <span class="muted-seconds">${timeMatch[3]}s</span>`;
      }
      
      // ä¿å­˜æ™‚ç‚¹ã§ã®è¡¨ç¤ºç”¨ã®æƒ…å ±ã‚’ä½œæˆ
      const displayInfo = {
        formattedTime: formattedTime,
        distance: `<span class="distance-display">0</span>m`,
        direction: `æ–¹ä½: <span class="direction-display">ï¼</span>`
      };
      
      const location = {
        latitude: currentPosition.coords.latitude,
        longitude: currentPosition.coords.longitude,
        timestamp: timeString,
        time: now.getTime(), // ãƒŸãƒªç§’å˜ä½ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
        id: Date.now(),
        savedDistance: distance,  // ä¿å­˜æ™‚ã®è·é›¢ã‚’è¨˜éŒ²
        displayInfo: displayInfo  // ä¿å­˜æ™‚ç‚¹ã§ã®è¡¨ç¤ºæƒ…å ±
      };
      
      // æœ€å¤§5ç®‡æ‰€ã¾ã§ä¿å­˜ï¼ˆæ–°ã—ã„ã‚‚ã®ã‚’å…ˆé ­ã«è¿½åŠ ï¼‰
      savedLocations.unshift(location);
      if (savedLocations.length > MAX_SAVED_LOCATIONS) {
        savedLocations.pop();
      }
      
      // æ—¢å­˜ã®ä¿å­˜åœ°ç‚¹ãŒã‚ã‚‹å ´åˆã€å„åœ°ç‚¹ã‹ã‚‰ç¾åœ¨ä½ç½®ã¾ã§ã®è·é›¢ã¨æ–¹ä½ã‚’è¨ˆç®—ã—ã¦æ›´æ–°
      for (let i = 1; i < savedLocations.length; i++) {
        const loc = savedLocations[i];
        
        // è·é›¢ã‚’è¨ˆç®—
        const distanceFromCurrent = haversineDistance(
          currentPosition.coords.latitude,
          currentPosition.coords.longitude,
          loc.latitude,
          loc.longitude
        );
        
        // æ–¹ä½è§’ã¨æ–¹ä½ã‚’è¨ˆç®—
        const bearingFromCurrent = calculateBearing(
          loc.latitude,
          loc.longitude,
          currentPosition.coords.latitude,
          currentPosition.coords.longitude
        );
        
        // è·é›¢ãŒ0mã®å ´åˆã¯æ–¹ä½ã‚’ã€Œï¼ã€ã¨è¡¨ç¤º
        const directionText = Math.round(distanceFromCurrent) === 0 ? "ï¼" : 
                   `<span class="direction-text">${bearingToDirection(bearingFromCurrent)}</span> <span class="direction-display">${Math.round(bearingFromCurrent).toString().padStart(3, '0')}</span>`;
        
        // ä¿å­˜ã•ã‚ŒãŸæƒ…å ±ã‚’æ›´æ–°
        loc.savedDistance = distanceFromCurrent;
        loc.savedBearing = bearingFromCurrent;
        loc.savedDirection = directionText;
        
        // è¡¨ç¤ºç”¨ã®æƒ…å ±ã‚‚æ›´æ–°
        loc.displayInfo = {
          formattedTime: loc.displayInfo ? loc.displayInfo.formattedTime : '',
          distance: `<span class="distance-display">${Math.round(distanceFromCurrent)}</span>m`,
          direction: `æ–¹ä½: <span class="direction-display">${directionText}</span>`
        };
      }
      
      updateSavedLocationsList();
      saveLocationsToStorage(); // ä¿å­˜å¾Œã«ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    }
    
    // ä¿å­˜åœ°ç‚¹ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    function updateSavedLocationsList() {
      savedLocationsListElem.innerHTML = '';
      
      savedLocations.forEach((loc, index) => {
        let displayDistance;
        let bearing = '';
        let direction = '';
        let timeDiff = '';
        let currentStats = '';
        
        if (currentPosition) {
          // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ï¼ˆæœ€æ–°ã®åœ°ç‚¹ï¼‰ã®å ´åˆã®ã¿ç¾åœ¨ä½ç½®ã‹ã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è·é›¢ãƒ»æ–¹ä½ã‚’è¨ˆç®—
          if (index === 0) {
            // ç¾åœ¨ä½ç½®ã‹ã‚‰ã®è·é›¢ã‚’è¨ˆç®—
            displayDistance = haversineDistance(
              currentPosition.coords.latitude, 
              currentPosition.coords.longitude,
              loc.latitude, 
              loc.longitude
            );
            
            // æ–¹ä½è§’ã¨æ–¹ä½ã‚’è¨ˆç®—
            bearing = calculateBearing(
              currentPosition.coords.latitude,
              currentPosition.coords.longitude,
              loc.latitude,
              loc.longitude
            );
            
            // è·é›¢ãŒ0mã®å ´åˆã¯æ–¹ä½ã‚’ã€Œï¼ã€ã¨è¡¨ç¤º
            direction = Math.round(displayDistance) === 0 ? "ï¼" : 
                       `<span class="direction-text">${bearingToDirection(bearing)}</span> <span class="direction-display">${Math.round(bearing).toString().padStart(3, '0')}</span>`;
            
            // æœ€æ–°ã®è¨˜éŒ²ã®ã¿ã€ç¾åœ¨ä½ç½®ã¨ã®æ™‚é–“å·®ã¨å¹³å‡é€Ÿåº¦ã‚’è¨ˆç®—
            const currentTime = new Date().getTime();
            const timeElapsedCurrent = (currentTime - loc.time) / (1000 * 60); // åˆ†å˜ä½
            
            if (timeElapsedCurrent > 0) {
              // ç¾åœ¨ä½ç½®ã¨æœ€æ–°åœ°ç‚¹é–“ã®è·é›¢ã‚’ä½¿ç”¨
              const currentSpeedMps = displayDistance / (timeElapsedCurrent * 60); // m/s
              const currentSpeedKnots = convertToKnots(currentSpeedMps);
              
              // ç¾åœ¨ä½ç½®ã¨ã®æƒ…å ±ã‚’è¿½åŠ 
              const totalMinutes = Math.floor(timeElapsedCurrent);
              const hours = Math.floor(totalMinutes / 60);
              const minutes = totalMinutes % 60;
              const seconds = Math.round((timeElapsedCurrent - Math.floor(timeElapsedCurrent)) * 60);
              currentStats = `<span class="minutes-value">${hours > 0 ? `${hours.toString().padStart(2, '0')}æ™‚é–“` : ''}${minutes.toString().padStart(2, '0')}åˆ† ${seconds.toString().padStart(2, '0')}</span>sçµŒé - å¹³å‡: <span class="speed-value">${currentSpeedKnots.toFixed(1)}</span>ãƒãƒƒãƒˆ`;
            }
          } else {
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1ä»¥é™ï¼ˆå¤ã„åœ°ç‚¹ï¼‰ã®å ´åˆã¯ä¿å­˜ã•ã‚ŒãŸè·é›¢ãƒ»æ–¹ä½ã‚’ä½¿ç”¨
            displayDistance = loc.savedDistance || 0;
            direction = loc.savedDirection || '';
          }
        } else {
          displayDistance = loc.savedDistance || 0;
          direction = loc.savedDirection || '';
        }
        
        const item = document.createElement('div');
        item.className = 'location-item';
        
        // ã‚´ãƒŸç®±ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
        const deleteIcon = document.createElement('div');
        deleteIcon.className = 'delete-icon';
        deleteIcon.innerHTML = 'ğŸ—‘ï¸';
        item.appendChild(deleteIcon);
        
        // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã‹ã©ã†ã‹ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
        let isSwiping = false;
        
        // Hammer.jsã§ã‚¹ãƒ¯ã‚¤ãƒ—å‡¦ç†ã‚’è¿½åŠ 
        const hammer = new Hammer(item);
        hammer.on('panstart panmove panend', (ev) => {
          if (ev.type === 'panstart') {
            isSwiping = true;
          } else if (ev.type === 'panmove') {
            const deltaX = Math.min(Math.max(ev.deltaX, 0), 400);
            item.style.transform = `translateX(${deltaX}px)`;
            item.classList.add('swiping');
            
            if (deltaX > 100) {
              item.classList.add('will-delete');
            } else {
              item.classList.remove('will-delete');
            }
          } else if (ev.type === 'panend') {
            item.classList.remove('swiping');
            if (ev.deltaX > 100) {
              // å‰Šé™¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
              item.style.transform = 'translateX(100%)';
              item.style.opacity = '0';
              setTimeout(() => {
                // é…åˆ—ã‹ã‚‰è¦ç´ ã‚’å‰Šé™¤
                savedLocations.splice(index, 1);
                saveLocationsToStorage();
                updateSavedLocationsList();
              }, 300);
            } else {
              // å…ƒã®ä½ç½®ã«æˆ»ã™
              item.style.transform = 'translateX(0)';
              item.classList.remove('will-delete');
            }
            // ã‚¹ãƒ¯ã‚¤ãƒ—çµ‚äº†å¾Œã€å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
            setTimeout(() => {
              isSwiping = false;
            }, 100);
          }
        });
        
        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’ä¿®æ­£
        item.addEventListener('click', () => {
          // ã‚¹ãƒ¯ã‚¤ãƒ—ä¸­ã§ãªã„å ´åˆã®ã¿åœ°å›³ã‚’è¡¨ç¤º
          if (!isSwiping) {
            const location = savedLocations[index];
            showMap(location.latitude, location.longitude);
          }
        });
        
        if (index === 0) {
          const currentStatsDiv = document.createElement('div');
          currentStatsDiv.className = 'location-stats';
          item.appendChild(currentStatsDiv);
          
          // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã®ãŸã‚ã®é–¢æ•°
          function updateCurrentStats() {
            const currentTime = new Date().getTime();
            const timeElapsedCurrent = (currentTime - loc.time) / (1000 * 60); // åˆ†å˜ä½
            
            if (timeElapsedCurrent > 0) {
              const totalMinutes = Math.floor(timeElapsedCurrent);
              const hours = Math.floor(totalMinutes / 60);
              const minutes = totalMinutes % 60;
              const seconds = Math.round((timeElapsedCurrent - Math.floor(timeElapsedCurrent)) * 60);
              
              const currentSpeedMps = displayDistance / (timeElapsedCurrent * 60); // m/s
              const currentSpeedKnots = convertToKnots(currentSpeedMps);
              
              currentStatsDiv.innerHTML = `<span class="minutes-value">${hours > 0 ? `${hours.toString().padStart(2, '0')}æ™‚é–“` : ''}${minutes.toString().padStart(2, '0')}åˆ† ${seconds.toString().padStart(2, '0')}</span>sçµŒé - å¹³å‡: <span class="speed-value">${currentSpeedKnots.toFixed(1)}</span>ãƒãƒƒãƒˆ`;
            }
          }
          
          // åˆå›ã«è¡¨ç¤ºã‚’æ›´æ–°
          updateCurrentStats();
          
          // 1ç§’ã”ã¨ã«æ›´æ–°
          setInterval(updateCurrentStats, 1000);
        }
        
        // åŸºæœ¬æƒ…å ±ï¼ˆæ™‚åˆ»ã€è·é›¢ã€æ–¹ä½ï¼‰
        const timeMatch = loc.timestamp.match(/(\d+):(\d+):(\d+)/);
        let formattedTime;
        
        if (timeMatch) {
          formattedTime = `<span class="time-display">${timeMatch[1]}:${timeMatch[2]}</span> <span class="time-display">${timeMatch[3]}</span>s`;
        } else {
          formattedTime = loc.timestamp || 'ä¸æ˜';
        }
        
        const basicInfoDiv = document.createElement('div');
        
        // æ–¹ä½è¡¨ç¤ºéƒ¨åˆ†ã‚’ä¿®æ­£
        let directionDisplay = direction;
        if (index > 0 && loc.savedDirection) {
          directionDisplay = `${loc.savedDirection}`;
        }
        
        basicInfoDiv.innerHTML = `${formattedTime} - è·é›¢: <span class="distance-display">${Math.round(displayDistance)}</span>m - æ–¹ä½: <span class="direction-display">${directionDisplay}</span>`;
        item.appendChild(basicInfoDiv);
        
        // åŒºåˆ‡ã‚Šç·šã‚’è¿½åŠ 
        const separator = document.createElement('hr');
        item.appendChild(separator);
                
        // å‰ã®åœ°ç‚¹ã¨ã®æ¯”è¼ƒæƒ…å ±ï¼ˆ2ã¤ç›®ä»¥é™ã®åœ°ç‚¹ã®ã¿ï¼‰
        if (index < savedLocations.length - 1) {
          const prevLoc = savedLocations[index + 1];
          const timeElapsed = (loc.time - prevLoc.time) / (1000 * 60); // åˆ†å˜ä½
          
          if (timeElapsed > 0) {
            const totalMinutes = Math.floor(timeElapsed);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const seconds = Math.round((timeElapsed - Math.floor(timeElapsed)) * 60);
            
            const pointDistance = haversineDistance(
              loc.latitude, loc.longitude,
              prevLoc.latitude, prevLoc.longitude
            );
            
            const speedMps = pointDistance / (timeElapsed * 60); // m/s
            const speedKnots = convertToKnots(speedMps);
            
            const prevStatsDiv = document.createElement('div');
            prevStatsDiv.className = 'location-stats';
            prevStatsDiv.innerHTML = `çµŒé: <span class="minutes-value">${hours > 0 ? `${hours.toString().padStart(2, '0')}æ™‚é–“` : ''}${minutes.toString().padStart(2, '0')}åˆ† ${seconds.toString().padStart(2, '0')}</span>s - å¹³å‡: <span class="speed-value">${speedKnots.toFixed(1)}</span>ãƒãƒƒãƒˆ`;
            item.appendChild(prevStatsDiv);
          }
        }

        savedLocationsListElem.appendChild(item);
      });
    }

    // ä½ç½®æƒ…å ±ã®æ›´æ–°æ™‚ã«å‘¼ã°ã‚Œã‚‹é–¢æ•°
    function handlePositionUpdate(pos) {
      currentPosition = pos;
      
      // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€Supabaseã«é€ä¿¡ã‚’è©¦ã¿ã‚‹
      if (raceUuid && racePassword) {
        if (navigator.onLine) {
          sendToSupabase(pos).catch(err => {
            console.error('Failed to send data:', err);
            offlineQueue.push(pos);
            saveOfflineQueue();
          });
        } else {
          offlineQueue.push(pos);
          saveOfflineQueue();
        }
      }

      // è©³ç´°ãªä½ç½®æƒ…å ±ã‚’5ç§’é–“éš”ã§ä¿å­˜
      const now = Date.now();
      if (now - lastDetailedPositionTime >= DETAILED_POSITION_INTERVAL) {
        saveDetailedPosition(pos);
        lastDetailedPositionTime = now;
      }

      statusElem.innerHTML = 
                           "ç·¯åº¦: " + pos.coords.latitude.toFixed(5).padStart(9, '0') + "<br>" +
                           "çµŒåº¦: " + pos.coords.longitude.toFixed(5).padStart(9, '0');
      
      // åˆå›å–å¾—æ™‚ã«lastAnnouncedPositionã‚’è¨­å®š
      if (!lastAnnouncedPosition) {
        lastAnnouncedPosition = pos;
        // åˆå›ã®é€Ÿåº¦è¨ˆç®—ã¨ç™ºè©±
        announceCurrentSpeed();
        // å®šæœŸçš„ãªç™ºè©±ã‚’é–‹å§‹
        if (intervalSeconds !== null) {
          if (announceIntervalId) {
            clearInterval(announceIntervalId);
          }
          announceIntervalId = setInterval(() => {
            if (currentPosition && lastAnnouncedPosition) {
              const speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
              const speedKnots = convertToKnots(speedMps);
              const smoothedSpeed = getSmoothedSpeed(speedKnots);
              updateSpeedDisplay(smoothedSpeed);
              
              // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸé€Ÿåº¦ãŒnullã§ãªã„å ´åˆã®ã¿ç™ºè©±
              if (smoothedSpeed !== null) {
                speakSpeed(smoothedSpeed);
                // æ¬¡å›ã®è¨ˆç®—ç”¨ã«ç¾åœ¨ã®ä½ç½®ã‚’è¨˜éŒ²
                lastAnnouncedPosition = currentPosition;
              }
            }
          }, intervalSeconds * 1000);
        }
      }
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€Ÿåº¦ã‚’æ›´æ–°
      if (lastAnnouncedPosition) {
        let speedMps;
        
        // GeolocationCoordinates.speedãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
        if (pos.coords.speed !== null && pos.coords.speed !== undefined) {
          speedMps = pos.coords.speed;
        } else {
          // å¾“æ¥ã®æ–¹æ³•ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          speedMps = calculateSpeed(lastAnnouncedPosition, currentPosition);
        }
        
        const speedKnots = convertToKnots(speedMps);
        const smoothedSpeed = getSmoothedSpeed(speedKnots);
        updateSpeedDisplay(smoothedSpeed);
      }
      
      // ä¿å­˜åœ°ç‚¹ãŒã‚ã‚Œã°è·é›¢ã‚’æ›´æ–°
      if (savedLocations.length > 0) {
        updateSavedLocationsList();
      }
      
      // ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒãƒƒãƒ—ã‚‚æ›´æ–°
      updateMapIfVisible();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    intervalDisplayContainerElem.addEventListener('click', toggleInterval);
    hereButton.addEventListener('click', saveCurrentLocation);

    // ã‚¢ãƒ—ãƒªèµ·å‹•æ™‚ã«è‡ªå‹•ã§é–‹å§‹
    function initialize() {
      statusElem.textContent = "ä½ç½®æƒ…å ±å–å¾—ä¸­...";
      
      loadIntervalFromStorage(); // ç§’æ•°ã‚’ãƒ­ãƒ¼ãƒ‰
      loadSavedLocationsFromStorage(); // ä¿å­˜ã—ãŸåœ°ç‚¹ã‚’ãƒ­ãƒ¼ãƒ‰
      loadOfflineQueue(); // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã‚’ãƒ­ãƒ¼ãƒ‰
      getRaceInfoFromUrl(); // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ã‚’å–å¾—

      // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚­ãƒ¥ãƒ¼ã®å‡¦ç†ã‚’è©¦ã¿ã‚‹
      processOfflineQueue();

      // é«˜ç²¾åº¦ã§ä½ç½®æƒ…å ±ã‚’å–å¾—ï¼ˆwatchPositionã§ç¶™ç¶šçš„ã«æ›´æ–°ï¼‰
      watchId = navigator.geolocation.watchPosition(
        handlePositionUpdate,
        (err) => {
          statusElem.textContent = "ã‚¨ãƒ©ãƒ¼: " + err.message;
        },
        { 
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 5000
        }
      );
    }

    // ä¿å­˜ã—ãŸåœ°ç‚¹ã®å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
    function clearSavedLocations() {
      savedLocations = [];
      updateSavedLocationsList();
      saveLocationsToStorage();
    }
    
    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
    let isDarkMode = localStorage.getItem('darkMode') === 'true';
    
    // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
    if (isDarkMode) {
      document.body.setAttribute('data-theme', 'dark');
    }

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆé–¢æ•°
    function toggleDarkMode() {
      isDarkMode = !isDarkMode;
      localStorage.setItem('darkMode', isDarkMode);
      document.body.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
    }

    // ã€Œä¿å­˜ã—ãŸåœ°ç‚¹ã€ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    savedLocationsTitle.addEventListener('click', () => {
      toggleDarkMode();
    });

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ãƒãƒƒãƒ—é–¢é€£ã®å¤‰æ•°ã‚’å®šç¾©
    let map = null;
    let mapModal = null;
    let mapElement = null;
    let isTrackingMode = false;
    let currentMapMode = 'speed'; // speed, satellite
    let speedSegments = []; // é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ
    let speedPolylines = []; // é€Ÿåº¦è¡¨ç¤ºç”¨ã®ãƒãƒªãƒ©ã‚¤ãƒ³é…åˆ—
    let speedFilterMode = 'all'; // é€Ÿåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰: 'all', 'low', 'medium', 'high'

    // ãƒãƒƒãƒ—è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function switchMapMode() {
      // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
      currentMapMode = currentMapMode === 'speed' ? 'satellite' : 'speed';
      
      // é€Ÿåº¦å‡¡ä¾‹ã¯å¸¸ã«è¡¨ç¤ºï¼ˆè¡›æ˜Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¡¨ç¤ºï¼‰
      // const speedLegend = document.getElementById('speedLegend');
      // speedLegend.style.display = currentMapMode === 'speed' ? 'block' : 'none';
      
      if (map) {
        // æ—¢å­˜ã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
        map.eachLayer(layer => {
          if (layer instanceof L.TileLayer) {
            map.removeLayer(layer);
          }
        });
        
        // é¸æŠã•ã‚ŒãŸãƒ¢ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
        if (currentMapMode === 'satellite') {
          L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
          }).addTo(map);
        } else {
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
          }).addTo(map);
        }
        
        // é€Ÿåº¦è¡¨ç¤ºã®åˆ‡æ›¿ - è¡›æ˜Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        speedPolylines.forEach(polyline => {
          polyline.setStyle({
            opacity: 0.8 // å¸¸ã«è¡¨ç¤º
          });
        });
        
        // è©³ç´°ãªçµŒè·¯æƒ…å ±ã®è¡¨ç¤º/éè¡¨ç¤º - è¡›æ˜Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        map.eachLayer(layer => {
          if (layer._detailedPath) {
            layer.setStyle({
              opacity: 0.8 // å¸¸ã«è¡¨ç¤º
            });
          }
        });
        
        // è©³ç´°çµŒè·¯ã‚’æ›´æ–° - è¡›æ˜Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚æ›´æ–°ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        updateDetailedPathOnMap();
      }
    }

    // è¿½è·¡ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
    function toggleTrackingMode() {
      isTrackingMode = !isTrackingMode;
      
      const trackModeBtn = document.getElementById('trackModeBtn');
      if (isTrackingMode) {
        trackModeBtn.classList.add('active');
        // ç¾åœ¨ä½ç½®ãŒã‚ã‚Œã°ã€ãã®ä½ç½®ã«ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’ç§»å‹•
        if (currentPosition && map) {
          map.setView([currentPosition.coords.latitude, currentPosition.coords.longitude], map.getZoom());
        }
      } else {
        trackModeBtn.classList.remove('active');
      }
    }

    // é€Ÿåº¦ã«å¿œã˜ãŸè‰²ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getSpeedColor(speed) {
      // é€Ÿåº¦ã«å¿œã˜ãŸè‰²ã‚’æ±ºå®šï¼ˆ0ï½10ãƒãƒƒãƒˆã‚’é’â†’ç·‘â†’èµ¤ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡¨ç¾ï¼‰
      const cappedSpeed = Math.min(speed, 10); // 10ãƒãƒƒãƒˆä»¥ä¸Šã¯åŒã˜è‰²ã«
      const ratio = cappedSpeed / 10;
      
      // é’(0,0,255) â†’ ç·‘(0,255,0) â†’ èµ¤(255,0,0)ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      let r, g, b;
      if (ratio < 0.5) {
        // é’ã‹ã‚‰ç·‘ã¸
        const factor = ratio * 2;
        r = 0;
        g = Math.round(255 * factor);
        b = Math.round(255 * (1 - factor));
      } else {
        // ç·‘ã‹ã‚‰èµ¤ã¸
        const factor = (ratio - 0.5) * 2;
        r = Math.round(255 * factor);
        g = Math.round(255 * (1 - factor));
        b = 0;
      }
      
      return `rgb(${r}, ${g}, ${b})`;
    }

    // ç¾åœ¨åœ°ã‚’ç›®ç«‹ã¤ã‚¢ã‚¤ã‚³ãƒ³ã§è¡¨ç¤ºã—ã€é€²è¡Œæ–¹å‘ã‚’ç¤ºã™é–¢æ•°
    function showMapWithEnhancedFeatures(lat, lng) {
      if (!mapModal) {
        mapModal = document.getElementById('mapModal');
      }
      if (!mapElement) {
        mapElement = document.getElementById('map');
      }
      
      mapModal.style.display = 'block';
      
      // æ—¢å­˜ã®ãƒãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤
      if (map) {
        map.remove();
        map = null;
      }
      
      // æ–°ã—ã„ãƒãƒƒãƒ—ã‚’ä½œæˆ
      map = L.map(mapElement).setView([lat, lng], 15);

      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // ã‚¹ã‚±ãƒ¼ãƒ«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
      L.control.scale({
        imperial: false,  // ãƒ¡ãƒ¼ãƒˆãƒ«æ³•ã®ã¿ã‚’è¡¨ç¤º
        position: 'bottomright'
      }).addTo(map);

      // é€Ÿåº¦å‡¡ä¾‹ã®è¡¨ç¤ºï¼ˆåˆæœŸè¡¨ç¤ºæ™‚ã«ç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
      const speedLegend = document.getElementById('speedLegend');
      if (speedLegend) {
        speedLegend.style.display = 'block';
        updateSpeedRangeOverlay(); // é€Ÿåº¦ç¯„å›²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ›´æ–°
      }

      // ç¾åœ¨ä½ç½®ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³
      const currentPositionIcon = L.divIcon({
        className: 'current-position-icon',
        html: '<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
        iconSize: [22, 22],
        iconAnchor: [11, 11]
      });

      // ä¿å­˜åœ°ç‚¹ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³
      const savedLocationIcon = L.divIcon({
        className: 'saved-location-icon',
        html: '<div style="background-color: #DB4437; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.5);"></div>',
        iconSize: [18, 18],
        iconAnchor: [9, 9]
      });

      const latlngs = [];
      speedSegments = [];
      speedPolylines = [];
      
      // ä¿å­˜ä½ç½®ã‚’è¿½åŠ 
      savedLocations.forEach((location, index) => {
        latlngs.push([location.latitude, location.longitude]);
        
        // é€Ÿåº¦ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ï¼ˆæ¬¡ã®åœ°ç‚¹ã¨ã®å¹³å‡é€Ÿåº¦ï¼‰
        if (index < savedLocations.length - 1) {
          const nextLoc = savedLocations[index + 1];
          const distance = haversineDistance(
            location.latitude, location.longitude,
            nextLoc.latitude, nextLoc.longitude
          );
          const timeDiff = (location.time - nextLoc.time) / 1000; // ç§’
          const speed = timeDiff > 0 ? convertToKnots(distance / timeDiff) : 0;
          
          speedSegments.push({
            start: [location.latitude, location.longitude],
            end: [nextLoc.latitude, nextLoc.longitude],
            speed: speed
          });
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ 
        const marker = L.marker([location.latitude, location.longitude], { icon: savedLocationIcon }).addTo(map);
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®è©³ç´°æƒ…å ±ã‚’ä½œæˆ
        let popupContent = `<div style="font-size: 14px;">
          <strong>æ™‚åˆ»:</strong> ${location.timestamp}<br>`;
        
        // æœ€æ–°ã®åœ°ç‚¹ï¼ˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹0ï¼‰ä»¥å¤–ã¯ã€å‰ã®åœ°ç‚¹ã¨ã®æ¯”è¼ƒæƒ…å ±ã‚’è¡¨ç¤º
        if (index < savedLocations.length - 1) {
          const prevLoc = savedLocations[index + 1];
          const timeElapsed = (location.time - prevLoc.time) / (1000 * 60); // åˆ†å˜ä½
          
          if (timeElapsed > 0) {
            const pointDistance = haversineDistance(
              location.latitude, location.longitude,
              prevLoc.latitude, prevLoc.longitude
            );
            
            const speedMps = pointDistance / (timeElapsed * 60); // m/s
            const speedKnots = convertToKnots(speedMps);
            
            popupContent += `<strong>åŒºé–“è·é›¢:</strong> ${Math.round(pointDistance)}m<br>
            <strong>æ‰€è¦æ™‚é–“:</strong> ${Math.floor(timeElapsed)}åˆ† ${Math.round((timeElapsed - Math.floor(timeElapsed)) * 60)}ç§’<br>
            <strong>å¹³å‡é€Ÿåº¦:</strong> ${speedKnots.toFixed(1)}ãƒãƒƒãƒˆ<br>`;
          }
        }
        
        popupContent += `</div>`;
        marker.bindPopup(popupContent);
      });

      // ç¾åœ¨ä½ç½®ã‚’è¿½åŠ 
      if (currentPosition) {
        const currentLat = currentPosition.coords.latitude;
        const currentLng = currentPosition.coords.longitude;
        latlngs.unshift([currentLat, currentLng]);
        
        // é€²è¡Œæ–¹å‘ã‚’å–å¾—ï¼ˆheadingï¼‰
        const heading = currentPosition.coords.heading;
        let headingIcon = currentPositionIcon;
        
        // é€²è¡Œæ–¹å‘ãŒã‚ã‚‹å ´åˆã¯çŸ¢å°ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ç”¨
        if (heading !== null && heading !== undefined && !isNaN(heading)) {
          headingIcon = L.divIcon({
            className: 'heading-icon',
            html: `<div style="background-color: #4285F4; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); position: relative;">
                    <div style="position: absolute; width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 12px solid #4285F4; transform: rotate(${heading}deg); transform-origin: center 75%; top: -10px; left: 2px;"></div>
                  </div>`,
            iconSize: [22, 22],
            iconAnchor: [11, 11]
          });
        }
        
        const marker = L.marker([currentLat, currentLng], { icon: headingIcon }).addTo(map);
        
        // ç¾åœ¨ä½ç½®ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æƒ…å ±
        const speed = currentPosition.coords.speed !== null ? 
                     convertToKnots(currentPosition.coords.speed).toFixed(1) + "ãƒãƒƒãƒˆ" : 
                     "ä¸æ˜";
        
        marker.bindPopup(`<div style="font-size: 14px;">
          <strong>ç¾åœ¨ä½ç½®</strong><br>
          <strong>é€Ÿåº¦:</strong> ${speed}<br>
          <strong>ç·¯åº¦:</strong> ${currentLat.toFixed(6)}<br>
          <strong>çµŒåº¦:</strong> ${currentLng.toFixed(6)}<br>
          ${currentPosition.coords.altitude !== null ? `<strong>é«˜åº¦:</strong> ${Math.round(currentPosition.coords.altitude)}m<br>` : ''}
          ${heading !== null && !isNaN(heading) ? `<strong>æ–¹ä½:</strong> ${Math.round(heading)}Â°<br>` : ''}
        </div>`);
        
        // æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
        updateMapInfoPanel();
      }

      // åŸºæœ¬ã®çµŒè·¯ç·šï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰
      L.polyline(latlngs, { color: '#666', weight: 3, opacity: 0.6 }).addTo(map);
      
      // é€Ÿåº¦ã«åŸºã¥ã„ãŸè‰²åˆ†ã‘çµŒè·¯
      speedSegments.forEach(segment => {
        const color = getSpeedColor(segment.speed);
        const visible = isSpeedVisible(segment.speed);
        
        // è‰²ä»˜ãã®ç·šã‚’æç”»
        const polyline = L.polyline([segment.start, segment.end], { 
          color: color, 
          weight: 5, 
          opacity: visible ? 0.8 : 0,
          lineCap: 'round',
          lineJoin: 'round',
          speed: segment.speed, // é€Ÿåº¦æƒ…å ±ã‚’ä¿å­˜
          timestamp: location.time // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
        }).addTo(map);
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å»ƒæ­¢ã—ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        polyline.on('click', function(e) {
          // ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã‚’å–å¾—
          const clickLatLng = e.latlng;
          
          // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
          if (speedMarker) {
            map.removeLayer(speedMarker);
          }
          
          // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
          if (speedMarkerTimer) {
            clearTimeout(speedMarkerTimer);
          }
          
          // é¸æŠã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
          selectedSegment = {
            speed: segment.speed,
            timestamp: location.time,
            latlng: clickLatLng
          };
          
          // é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
          const markerIcon = L.divIcon({
            className: 'speed-marker',
            html: `${segment.speed.toFixed(1)}`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          });
          
          // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
          speedMarker = L.marker(clickLatLng, {
            icon: markerIcon,
            draggable: true // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«è¨­å®š
          }).addTo(map);
          
          // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
          speedMarker.on('drag', function(e) {
            // ç·šä¸Šã«æ²¿ã£ã¦ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ãŸã‚ã®å‡¦ç†
            const closestPoint = L.LineUtil.closestPointOnSegment(
              map.latLngToLayerPoint(e.latlng),
              map.latLngToLayerPoint(L.latLng(segment.start[0], segment.start[1])),
              map.latLngToLayerPoint(L.latLng(segment.end[0], segment.end[1]))
            );
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ç·¯åº¦çµŒåº¦ã«å¤‰æ›
            const closestLatLng = map.layerPointToLatLng(closestPoint);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
            speedMarker.setLatLng(closestLatLng);
            
            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (speedMarkerTimer) {
              clearTimeout(speedMarkerTimer);
            }
            speedMarkerTimer = setTimeout(clearSpeedMarker, SPEED_MARKER_TIMEOUT);
          });
          
          // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
          speedMarker.on('dragend', function(e) {
            // é¸æŠä½ç½®ã‚’æ›´æ–°
            selectedSegment.latlng = speedMarker.getLatLng();
            
            // æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
            updateSelectedSegmentInfo();
            
            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (speedMarkerTimer) {
              clearTimeout(speedMarkerTimer);
            }
            speedMarkerTimer = setTimeout(clearSpeedMarker, SPEED_MARKER_TIMEOUT);
          });
          
          // æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
          updateSelectedSegmentInfo();
          
          // 30ç§’å¾Œã«é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯ã‚’æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
          speedMarkerTimer = setTimeout(clearSpeedMarker, SPEED_MARKER_TIMEOUT);
        });
        
        speedPolylines.push(polyline);
        
        // é¸æŠã—ãŸé€Ÿåº¦ç¯„å›²ã®å ´åˆã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
        if (speedFilterMode !== 'all' && visible) {
          setTimeout(() => {
            if (polyline._path) {
              polyline._path.classList.add('animated-line');
            }
          }, 100);
        }
      });
      
      // è©³ç´°ãªçµŒè·¯æƒ…å ±ã‚’è¡¨ç¤º
      updateDetailedPathOnMap();
      
      // ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã«invalidateSizeã‚’å‘¼ã³å‡ºã™
      setTimeout(() => {
        map.invalidateSize();
      }, 100);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
      setupMapEventListeners();
    }

    // æƒ…å ±ãƒ‘ãƒãƒ«ã®æ›´æ–°
    function updateMapInfoPanel() {
      if (!currentPosition || !document.getElementById('mapCurrentSpeed')) return;
      
      // é€Ÿåº¦æƒ…å ±ã®åˆæœŸè¡¨ç¤ºã‚’å»ƒæ­¢
      // æ–¹ä½æƒ…å ±ã®åˆæœŸè¡¨ç¤ºã‚’å»ƒæ­¢
      
      // é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«é€Ÿåº¦ã‚’è¡¨ç¤º
      if (selectedSegment) {
        const speedElem = document.getElementById('mapSelectedSpeed');
        speedElem.textContent = `é¸æŠ: ${selectedSegment.speed.toFixed(1)} ãƒãƒƒãƒˆ`;
        speedElem.style.display = 'block';
      }
    }

    // ãƒãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    function setupMapEventListeners() {
      // ãƒãƒƒãƒ—è¡¨ç¤ºåˆ‡æ›¿ãƒœã‚¿ãƒ³ã®ä»£ã‚ã‚Šã«æƒ…å ±ãƒ‘ãƒãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      document.getElementById('mapInfoPanel').addEventListener('click', switchMapMode);
      
      // è¿½è·¡ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
      document.getElementById('trackModeBtn').addEventListener('click', toggleTrackingMode);
      
      // é€Ÿåº¦å‡¡ä¾‹ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      document.getElementById('speedLegend').addEventListener('click', toggleSpeedFilter);
      
      // ãƒãƒƒãƒ—ç§»å‹•æ™‚ã«è©³ç´°çµŒè·¯ã‚’æ›´æ–°
      map.on('moveend', () => {
        updateDetailedPathOnMap();
      });
    }

    // ä½ç½®æƒ…å ±æ›´æ–°æ™‚ã«ãƒãƒƒãƒ—ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateMapIfVisible() {
      if (mapModal && mapModal.style.display === 'block' && map && currentPosition) {
        // è¿½è·¡ãƒ¢ãƒ¼ãƒ‰ãŒã‚ªãƒ³ã®å ´åˆã€ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’ç¾åœ¨ä½ç½®ã«ç§»å‹•
        if (isTrackingMode) {
          map.setView([currentPosition.coords.latitude, currentPosition.coords.longitude], map.getZoom());
        }
        
        // æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
        updateMapInfoPanel();
        
        // è©³ç´°ãªçµŒè·¯æƒ…å ±ã‚’æ›´æ–° - è¡›æ˜Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚æ›´æ–°ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        updateDetailedPathOnMap();
        
        // é¸æŠæƒ…å ±ãŒã‚ã‚‹å ´åˆã¯æ›´æ–°
        if (selectedSegment) {
          updateSelectedSegmentInfo();
        }
      }
    }

    // è©³ç´°ãªä½ç½®æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveDetailedPosition(pos) {
      // ä½ç½®æƒ…å ±ã¨æ™‚åˆ»ã‚’ä¿å­˜
      const detailedPosition = {
        latitude: pos.coords.latitude,
        longitude: pos.coords.longitude,
        timestamp: pos.timestamp,
        speed: pos.coords.speed,
        heading: pos.coords.heading,
        altitude: pos.coords.altitude
      };
      
      // é…åˆ—ã®å…ˆé ­ã«è¿½åŠ 
      detailedPositionHistory.unshift(detailedPosition);
      
      // æœ€å¤§ä¿æŒæ•°ã‚’è¶…ãˆãŸå ´åˆã€å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
      if (detailedPositionHistory.length > MAX_DETAILED_POSITIONS) {
        detailedPositionHistory.pop();
      }
      
      // ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
      updateDetailedPathOnMap();
    }
    
    // ãƒãƒƒãƒ—ä¸Šã«è©³ç´°ãªçµŒè·¯ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateDetailedPathOnMap() {
      if (!map || !mapModal || mapModal.style.display !== 'block' || detailedPositionHistory.length < 2) {
        return;
      }
      
      // æ—¢å­˜ã®è©³ç´°çµŒè·¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
      map.eachLayer(layer => {
        if (layer._detailedPath) {
          map.removeLayer(layer);
        }
      });
      
      // è©³ç´°ãªä½ç½®æƒ…å ±ã‹ã‚‰çµŒè·¯ã¨é€Ÿåº¦ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ
      const detailedLatlngs = detailedPositionHistory.map(pos => [pos.latitude, pos.longitude]);
      const detailedSpeedSegments = [];
      
      for (let i = 0; i < detailedPositionHistory.length - 1; i++) {
        const current = detailedPositionHistory[i];
        const next = detailedPositionHistory[i + 1];
        
        // è·é›¢ã‚’è¨ˆç®—
        const distance = haversineDistance(
          current.latitude, current.longitude,
          next.latitude, next.longitude
        );
        
        // æ™‚é–“å·®ã‚’è¨ˆç®—ï¼ˆç§’ï¼‰
        const timeDiff = (current.timestamp - next.timestamp) / 1000;
        
        // é€Ÿåº¦ã‚’è¨ˆç®—ï¼ˆãƒãƒƒãƒˆï¼‰
        let speed;
        if (current.speed !== null && current.speed !== undefined) {
          speed = convertToKnots(current.speed);
        } else if (timeDiff > 0) {
          speed = convertToKnots(distance / timeDiff);
        } else {
          speed = 0;
        }
        
        detailedSpeedSegments.push({
          start: [current.latitude, current.longitude],
          end: [next.latitude, next.longitude],
          speed: speed,
          distance: distance,
          time: timeDiff
        });
      }
      
      // è©³ç´°ãªé€Ÿåº¦ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’åœ°å›³ã«è¡¨ç¤º
      detailedSpeedSegments.forEach(segment => {
        const color = getSpeedColor(segment.speed);
        const visible = isSpeedVisible(segment.speed);
        
        // è‰²ä»˜ãã®ç·šã‚’æç”» - è¡›æ˜Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        const polyline = L.polyline([segment.start, segment.end], { 
          color: color, 
          weight: 4, 
          opacity: visible ? 0.8 : 0, // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åŸºã¥ã„ã¦è¡¨ç¤º/éè¡¨ç¤º
          lineCap: 'round',
          lineJoin: 'round',
          _detailedPath: true, // ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è­˜åˆ¥
          speed: segment.speed, // é€Ÿåº¦æƒ…å ±ã‚’ä¿å­˜
          time: segment.time, // æ™‚é–“æƒ…å ±ã‚’ä¿å­˜
          timestamp: current.timestamp // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¿å­˜
        }).addTo(map);
        
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’å»ƒæ­¢ã—ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        polyline.on('click', function(e) {
          // ã‚¯ãƒªãƒƒã‚¯ã—ãŸä½ç½®ã‚’å–å¾—
          const clickLatLng = e.latlng;
          
          // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
          if (speedMarker) {
            map.removeLayer(speedMarker);
          }
          
          // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
          if (speedMarkerTimer) {
            clearTimeout(speedMarkerTimer);
          }
          
          // é¸æŠã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
          selectedSegment = {
            speed: segment.speed,
            timestamp: current.timestamp,
            latlng: clickLatLng
          };
          
          // é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
          const markerIcon = L.divIcon({
            className: 'speed-marker',
            html: `${segment.speed.toFixed(1)}`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          });
          
          // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
          speedMarker = L.marker(clickLatLng, {
            icon: markerIcon,
            draggable: true // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«è¨­å®š
          }).addTo(map);
          
          // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
          speedMarker.on('drag', function(e) {
            // ç·šä¸Šã«æ²¿ã£ã¦ãƒ‰ãƒ©ãƒƒã‚°ã™ã‚‹ãŸã‚ã®å‡¦ç†
            const closestPoint = L.LineUtil.closestPointOnSegment(
              map.latLngToLayerPoint(e.latlng),
              map.latLngToLayerPoint(L.latLng(segment.start[0], segment.start[1])),
              map.latLngToLayerPoint(L.latLng(segment.end[0], segment.end[1]))
            );
            
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’ç·¯åº¦çµŒåº¦ã«å¤‰æ›
            const closestLatLng = map.layerPointToLatLng(closestPoint);
            
            // ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°
            speedMarker.setLatLng(closestLatLng);
            
            // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (speedMarkerTimer) {
              clearTimeout(speedMarkerTimer);
            }
            speedMarkerTimer = setTimeout(clearSpeedMarker, SPEED_MARKER_TIMEOUT);
          });
          
          // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
          speedMarker.on('dragend', function(e) {
            // é¸æŠä½ç½®ã‚’æ›´æ–°
            selectedSegment.latlng = speedMarker.getLatLng();
            
            // æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
            updateSelectedSegmentInfo();
            
            // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (speedMarkerTimer) {
              clearTimeout(speedMarkerTimer);
            }
            speedMarkerTimer = setTimeout(clearSpeedMarker, SPEED_MARKER_TIMEOUT);
          });
          
          // æƒ…å ±ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
          updateSelectedSegmentInfo();
          
          // 30ç§’å¾Œã«é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯ã‚’æ¶ˆã™ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š
          speedMarkerTimer = setTimeout(clearSpeedMarker, SPEED_MARKER_TIMEOUT);
        });
        
        // é¸æŠã—ãŸé€Ÿåº¦ç¯„å›²ã®å ´åˆã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
        if (speedFilterMode !== 'all' && visible) {
          setTimeout(() => {
            if (polyline._path) {
              polyline._path.classList.add('animated-detailed-line');
            }
          }, 100);
        }
      });
    }
    
    // é¸æŠã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æƒ…å ±ã‚’ãƒ‘ãƒãƒ«ã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateSelectedSegmentInfo() {
      if (!selectedSegment) return;
      
      // é€Ÿåº¦æƒ…å ±ã‚’è¡¨ç¤º
      const speedElem = document.getElementById('mapSelectedSpeed');
      speedElem.textContent = `é¸æŠ: ${selectedSegment.speed.toFixed(1)} ãƒãƒƒãƒˆ`;
      speedElem.style.display = 'block';
      
      // æ™‚é–“æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆä½•åˆ†å‰ã‹ï¼‰
      const timeElem = document.getElementById('mapSelectedTime');
      const now = Date.now();
      const diffMs = now - selectedSegment.timestamp;
      const diffMinutes = Math.floor(diffMs / 60000);
      
      if (diffMinutes < 1) {
        timeElem.textContent = `æ™‚é–“: ãŸã£ãŸä»Š`;
      } else {
        timeElem.textContent = `æ™‚é–“: ${diffMinutes} åˆ†å‰`;
      }
      timeElem.style.display = 'block';
    }
    
    // é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
    function clearSpeedMarker() {
      if (map && speedMarker) {
        map.removeLayer(speedMarker);
        speedMarker = null;
      }
      
      // é¸æŠæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
      selectedSegment = null;
      
      // æƒ…å ±ãƒ‘ãƒãƒ«ã®é¸æŠæƒ…å ±ã‚’éè¡¨ç¤º
      const speedElem = document.getElementById('mapSelectedSpeed');
      const timeElem = document.getElementById('mapSelectedTime');
      if (speedElem) speedElem.style.display = 'none';
      if (timeElem) timeElem.style.display = 'none';
      
      // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (speedMarkerTimer) {
        clearTimeout(speedMarkerTimer);
        speedMarkerTimer = null;
      }
    }

    // ãƒãƒƒãƒ—ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©
    function showMap(lat, lng) {
      // æ‹¡å¼µã•ã‚ŒãŸãƒãƒƒãƒ—è¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã™
      showMapWithEnhancedFeatures(lat, lng);
    }

    // ãƒãƒƒãƒ—ã‚’é–‰ã˜ã‚‹é–¢æ•°
    function closeMap() {
      if (mapModal) {
        mapModal.style.display = 'none';
      }
      if (map) {
        map.remove();
        map = null;
      }
      
      // é€Ÿåº¦è¡¨ç¤ºãƒãƒ¼ã‚¯ã¨é¸æŠæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
      speedMarker = null;
      selectedSegment = null;
      
      // æƒ…å ±ãƒ‘ãƒãƒ«ã®é¸æŠæƒ…å ±ã‚’éè¡¨ç¤º
      const speedElem = document.getElementById('mapSelectedSpeed');
      const timeElem = document.getElementById('mapSelectedTime');
      if (speedElem) speedElem.style.display = 'none';
      if (timeElem) timeElem.style.display = 'none';
      
      // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (speedMarkerTimer) {
        clearTimeout(speedMarkerTimer);
        speedMarkerTimer = null;
      }
    }

    // ãƒãƒƒãƒ—ã‚’åˆæœŸåŒ–ã™ã‚‹é–¢æ•°
    function initMap() {
      if (!mapModal) {
        mapModal = document.getElementById('mapModal');
      }
      if (!mapElement) {
        mapElement = document.getElementById('map');
      }
      const closeMapBtn = document.getElementById('closeMapBtn');
      
      closeMapBtn.addEventListener('click', closeMap);
      
      // è¿½è·¡ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®åˆæœŸè¨­å®š
      const trackModeBtn = document.getElementById('trackModeBtn');
      if (trackModeBtn) {
        trackModeBtn.classList.remove('active');
        isTrackingMode = false;
      }
      
      // ãƒãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸè¨­å®š
      currentMapMode = 'speed';
      const toggleBtn = document.getElementById('toggleMapMode');
      if (toggleBtn) {
        toggleBtn.textContent = 'é€Ÿåº¦';
      }
      
      // é€Ÿåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®åˆæœŸè¨­å®š
      speedFilterMode = 'all';
      const speedLegendMode = document.getElementById('speedLegendMode');
      if (speedLegendMode) {
        speedLegendMode.textContent = 'é€Ÿåº¦ (ãƒãƒƒãƒˆ)';
      }
    }

    // é€Ÿåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function toggleSpeedFilter() {
      // é€Ÿåº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆ
      switch (speedFilterMode) {
        case 'all':
          speedFilterMode = 'low';
          document.getElementById('speedLegendMode').textContent = '0-3ãƒãƒƒãƒˆ';
          break;
        case 'low':
          speedFilterMode = 'medium';
          document.getElementById('speedLegendMode').textContent = '3-6ãƒãƒƒãƒˆ';
          break;
        case 'medium':
          speedFilterMode = 'high';
          document.getElementById('speedLegendMode').textContent = '6+ãƒãƒƒãƒˆ';
          break;
        case 'high':
          speedFilterMode = 'all';
          document.getElementById('speedLegendMode').textContent = 'é€Ÿåº¦ (ãƒãƒƒãƒˆ)';
          break;
      }
      
      // é€Ÿåº¦è¡¨ç¤ºã‚’æ›´æ–°
      updateSpeedDisplay();
      
      // é€Ÿåº¦ç¯„å›²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ›´æ–°
      updateSpeedRangeOverlay();
    }
    
    // é€Ÿåº¦ç¯„å›²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateSpeedRangeOverlay() {
      const gradientElement = document.querySelector('.speed-legend-gradient');
      
      // æ—¢å­˜ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å‰Šé™¤
      const existingOverlays = document.querySelectorAll('.speed-range-overlay');
      existingOverlays.forEach(overlay => overlay.remove());
      
      // å…¨è¡¨ç¤ºã®å ´åˆã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã—ãªã„
      if (speedFilterMode === 'all') {
        return;
      }
      
      // é€Ÿåº¦ç¯„å›²ã«å¿œã˜ãŸã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆï¼ˆé¸æŠã—ãŸç¯„å›²ä»¥å¤–ã‚’è¦†ã†ï¼‰
      const overlay1 = document.createElement('div');
      const overlay2 = document.createElement('div');
      overlay1.className = 'speed-range-overlay';
      overlay2.className = 'speed-range-overlay';
      
      const totalWidth = 150; // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å¹…
      
      switch (speedFilterMode) {
        case 'low':
          // 0-3ãƒãƒƒãƒˆä»¥å¤–ã®éƒ¨åˆ†ã‚’è¦†ã† (3-10+ãƒãƒƒãƒˆ)
          overlay1.style.left = `${3 / 10 * totalWidth}px`;
          overlay1.style.width = `${(10 - 3) / 10 * totalWidth}px`;
          gradientElement.appendChild(overlay1);
          break;
        case 'medium':
          // 0-3ãƒãƒƒãƒˆã®éƒ¨åˆ†ã‚’è¦†ã†
          overlay1.style.left = '0';
          overlay1.style.width = `${3 / 10 * totalWidth}px`;
          // 6-10+ãƒãƒƒãƒˆã®éƒ¨åˆ†ã‚’è¦†ã†
          overlay2.style.left = `${6 / 10 * totalWidth}px`;
          overlay2.style.width = `${(10 - 6) / 10 * totalWidth}px`;
          gradientElement.appendChild(overlay1);
          gradientElement.appendChild(overlay2);
          break;
        case 'high':
          // 0-6ãƒãƒƒãƒˆã®éƒ¨åˆ†ã‚’è¦†ã†
          overlay1.style.left = '0';
          overlay1.style.width = `${6 / 10 * totalWidth}px`;
          gradientElement.appendChild(overlay1);
          break;
      }
    }
    
    // é€Ÿåº¦è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateSpeedDisplay() {
      // ä¿å­˜ã•ã‚ŒãŸçµŒè·¯ã®è¡¨ç¤ºã‚’æ›´æ–°
      speedPolylines.forEach(polyline => {
        const speed = polyline.options.speed;
        const visible = isSpeedVisible(speed);
        
        if (speedFilterMode === 'all') {
          // å…¨è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã¯é€šå¸¸ã®ä¸é€æ˜åº¦ã§è¡¨ç¤º
          polyline.setStyle({
            opacity: 0.8,
            weight: 5,
            color: getSpeedColor(speed) // å…ƒã®è‰²ã‚’ä½¿ç”¨
          });
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          polyline._path.classList.remove('animated-line');
          // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          polyline._path.classList.remove('speed-highlighted-path');
          // é€šå¸¸ã®ç·šç”¨ã®å½±ã‚’è¿½åŠ 
          polyline._path.style.filter = 'drop-shadow(0 0 1px rgba(0, 0, 0, 0.5))';
        } else if (visible) {
          // é¸æŠã—ãŸé€Ÿåº¦ç¯„å›²ã¯å¼·èª¿è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã¨å½±ã‚’é©ç”¨ï¼‰
          polyline.setStyle({
            opacity: 1.0,
            weight: 5, // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å¤‰åŒ–ã™ã‚‹ãŸã‚åŸºæœ¬å€¤ã¯é€šå¸¸ã¨åŒã˜ã«
            color: getSpeedColor(speed) // å…ƒã®è‰²ã‚’ä½¿ç”¨
          });
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          polyline._path.classList.add('animated-line');
          // å½±åŠ¹æœã‚’è¿½åŠ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨åˆã‚ã›ã¦ï¼‰
          polyline._path.style.filter = 'drop-shadow(0 0 3px rgba(255, 255, 255, 0.8))';
          // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          polyline._path.classList.add('speed-highlighted-path');
        } else {
          // é¸æŠã—ã¦ã„ãªã„é€Ÿåº¦ç¯„å›²ã¯ç™½è‰²ã§è¡¨ç¤º
          polyline.setStyle({
            opacity: 0.8,
            weight: 5,
            color: '#ffffff' // ç™½è‰²ã«å¤‰æ›´
          });
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
          polyline._path.classList.remove('animated-line');
          // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
          polyline._path.classList.remove('speed-highlighted-path');
          // ç™½ã„ç·šç”¨ã®å½±ã‚’è¿½åŠ ï¼ˆé»’ã„å½±ã§ç™½ã„ç·šã‚’ç›®ç«‹ãŸã›ã‚‹ï¼‰
          polyline._path.style.filter = 'drop-shadow(0 0 2px rgba(0, 0, 0, 0.7))';
        }
      });
      
      // è©³ç´°ãªçµŒè·¯æƒ…å ±ã®è¡¨ç¤ºã‚’æ›´æ–°
      map.eachLayer(layer => {
        if (layer._detailedPath) {
          const speed = layer.options.speed;
          const visible = isSpeedVisible(speed);
          
          if (speedFilterMode === 'all') {
            // å…¨è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã¯é€šå¸¸ã®ä¸é€æ˜åº¦ã§è¡¨ç¤º
            layer.setStyle({
              opacity: 0.8,
              weight: 4,
              color: getSpeedColor(speed) // å…ƒã®è‰²ã‚’ä½¿ç”¨
            });
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            if (layer._path) {
              layer._path.classList.remove('animated-detailed-line');
              // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
              layer._path.classList.remove('speed-highlighted-path');
              // é€šå¸¸ã®ç·šç”¨ã®å½±ã‚’è¿½åŠ 
              layer._path.style.filter = 'drop-shadow(0 0 1px rgba(0, 0, 0, 0.5))';
            }
          } else if (visible) {
            // é¸æŠã—ãŸé€Ÿåº¦ç¯„å›²ã¯å¼·èª¿è¡¨ç¤ºï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã¨å½±ã‚’é©ç”¨ï¼‰
            layer.setStyle({
              opacity: 1.0,
              weight: 4, // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§å¤‰åŒ–ã™ã‚‹ãŸã‚åŸºæœ¬å€¤ã¯é€šå¸¸ã¨åŒã˜ã«
              color: getSpeedColor(speed) // å…ƒã®è‰²ã‚’ä½¿ç”¨
            });
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            if (layer._path) {
              layer._path.classList.add('animated-detailed-line');
              // å½±åŠ¹æœã‚’è¿½åŠ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨åˆã‚ã›ã¦ï¼‰
              layer._path.style.filter = 'drop-shadow(0 0 3px rgba(255, 255, 255, 0.8))';
              // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
              layer._path.classList.add('speed-highlighted-path');
            }
          } else {
            // é¸æŠã—ã¦ã„ãªã„é€Ÿåº¦ç¯„å›²ã¯ç™½è‰²ã§è¡¨ç¤º
            layer.setStyle({
              opacity: 0.8,
              weight: 4,
              color: '#ffffff' // ç™½è‰²ã«å¤‰æ›´
            });
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            if (layer._path) {
              layer._path.classList.remove('animated-detailed-line');
              // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
              layer._path.classList.remove('speed-highlighted-path');
              // ç™½ã„ç·šç”¨ã®å½±ã‚’è¿½åŠ ï¼ˆé»’ã„å½±ã§ç™½ã„ç·šã‚’ç›®ç«‹ãŸã›ã‚‹ï¼‰
              layer._path.style.filter = 'drop-shadow(0 0 2px rgba(0, 0, 0, 0.7))';
            }
          }
        }
      });
    }
    
    // é€Ÿåº¦ãŒç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§è¡¨ç¤ºã™ã¹ãã‹ã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
    function isSpeedVisible(speed) {
      switch (speedFilterMode) {
        case 'low':
          return speed < 3;
        case 'medium':
          return speed >= 3 && speed < 6;
        case 'high':
          return speed >= 6;
        case 'all':
        default:
          return true;
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', () => {
      initialize();
      initMap(); // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
    });
  </script>
</body>
</html>
